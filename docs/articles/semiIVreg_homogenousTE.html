<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Estimator Performance: homogenous treatment effect model • semiIVreg</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Estimator Performance: homogenous treatment effect model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">semiIVreg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/semiIVreg.html">Model and Guidelines</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-more" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">More</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-more">
<li><a class="dropdown-item" href="../articles/semiIVreg_homogenousTE.html">Estimation with Homogenous Treatment Effect</a></li>
    <li><a class="dropdown-item" href="../articles/semiIVreg_heterogenousTE.html">Estimation with general Heterogenous Treatment Effect</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/CBruneelZupanc" aria-label="Twitter"><span class="fa fa-twitter"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cbruneelzupanc/semiIVreg" aria-label="Github"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Estimator Performance: homogenous treatment effect model</h1>
                        <h4 data-toc-skip class="author"><a href="https://www.cbruneel.com/" class="external-link">Christophe Bruneel-Zupanc</a></h4>
            
            <h4 data-toc-skip class="date">Last modified:
2024-07-22</h4>
      

      <div class="d-none name"><code>semiIVreg_homogenousTE.Rmd</code></div>
    </div>

    
    
<p>Let us compare the performance of the semi-IV estimator under
different violation of the standard IV assumptions. This note mimics the
Appendix on <span class="citation">Bruneel-Zupanc (2024)</span>.</p>
<div class="section level2">
<h2 id="simulating-data">Simulating data<a class="anchor" aria-label="anchor" href="#simulating-data"></a>
</h2>
<p>We simulate generalized Roy models using the
<code><a href="../reference/simul_data.html">simul_data()</a></code>function. See the documentation of the function
for details about the model. Depending on the chosen parameters, we can
simulate a model with homogenous/heterogenous treatment effects, as well
as with valid IVs eventually. That’s what we will do here. In every
simulation we do not include covariates (set all their effect to 0), but
these can be easily included.</p>
</div>
<div class="section level2">
<h2 id="model-with-homogenous-treatment-effects">Model with homogenous treatment effects<a class="anchor" aria-label="anchor" href="#model-with-homogenous-treatment-effects"></a>
</h2>
<div class="section level3">
<h3 id="simulate-data">Simulate data<a class="anchor" aria-label="anchor" href="#simulate-data"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Model 1</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.cbruneel.com/" class="external-link">semiIVreg</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; KernSmooth 2.23 loaded</span></span>
<span><span class="co">#&gt; Copyright M. P. Wand 1997-2009</span></span>
<span><span class="co">#&gt; Loading required package: zoo</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'zoo'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:data.table':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     yearmon, yearqtr</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     as.Date, as.Date.numeric</span></span>
<span><span class="va">N</span> <span class="op">=</span> <span class="fl">10000</span>; <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">model_type</span> <span class="op">=</span> <span class="st">"homogenous"</span></span>
<span><span class="va">param_error</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1.5</span>, <span class="op">-</span><span class="fl">0.6</span><span class="op">)</span> <span class="co"># var_u, var_v, cov_uv # if homogenous</span></span>
<span><span class="va">param_Z</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1.5</span>, <span class="fl">1.5</span>, <span class="fl">0.9</span><span class="op">)</span> <span class="co"># meanW0 state0, meanW1 state0, meanW0 state1, meanW1 state1, varW0, varW1, covW0W1</span></span>
<span><span class="va">param_p</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># constant, alphaW0, alphaW1, alphaW0W1, effect of state, effect of parent educ</span></span>
<span><span class="va">param_y0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.2</span>, <span class="fl">0.8</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># intercept, effect of Wd, effect of state, effect of parent educ;</span></span>
<span><span class="va">param_y1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.2</span><span class="op">+</span><span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># the +0.2 = Average treatment effect; effect of W1, effect of state, effect of parent educ;</span></span>
<span><span class="va">param_genX</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span> <span class="co"># probability state=1 (instead of 0), mean_parenteduc, sd_parenteduc (parenteduc drawn as continuous)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="../reference/simul_data.html">simul_data</a></span><span class="op">(</span><span class="va">N</span>, <span class="va">model_type</span>, <span class="va">param_y0</span>, <span class="va">param_y1</span>, <span class="va">param_p</span>, <span class="va">param_Z</span>, <span class="va">param_genX</span>, <span class="va">param_error</span><span class="op">)</span></span></code></pre></div>
<p>This is a model with homogenous Treatment Effects (conditional on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>0</mn></msub><mo>,</mo><msub><mi>W</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">W_0, W_1</annotation></semantics></math>).</p>
</div>
<div class="section level3">
<h3 id="true-unobserved-homogenous-treatment-effects">True unobserved homogenous Treatment Effects<a class="anchor" aria-label="anchor" href="#true-unobserved-homogenous-treatment-effects"></a>
</h3>
<p>Here, at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>W</mi><mn>0</mn></msub><mo>,</mo><msub><mi>W</mi><mn>1</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">(W_0, W_1) = (0, 0)</annotation></semantics></math>,
the effect is always 0.4 (see the parameters). To see this, let us just
use the true <em>unobserved</em> potential outcomes (only observed
thanks to the simulation).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span><span class="op">$</span><span class="va">true_TE</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">y1</span> <span class="op">-</span> <span class="va">data</span><span class="op">$</span><span class="va">y0</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">true_TE</span> <span class="op">~</span> <span class="va">w0</span> <span class="op">+</span> <span class="va">w1</span>, <span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = true_TE ~ w0 + w1, data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;        Min         1Q     Median         3Q        Max </span></span>
<span><span class="co">#&gt; -5.753e-13 -1.600e-16  5.000e-17  2.700e-16  1.548e-13 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;               Estimate Std. Error            t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  4.000e-01  6.099e-17   6558145526539307   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; w0          -8.000e-01  6.196e-17 -12911565410646968   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; w1           5.000e-01  6.226e-17   8030568306192379   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 6.099e-15 on 9997 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:      1,  Adjusted R-squared:      1 </span></span>
<span><span class="co">#&gt; F-statistic: 8.343e+31 on 2 and 9997 DF,  p-value: &lt; 2.2e-16</span></span>
<span><span class="va">true_param</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">param_y0</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">param_y1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">param_y0</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">param_y0</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">param_y1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>; <span class="va">true_param</span></span>
<span><span class="co">#&gt; [1] 3.2 0.4 0.8 0.5</span></span>
<span><span class="co"># constant y0, constant y1 - constant y0, effects of w0 on y0, effects of w1 on y1.</span></span></code></pre></div>
<p>This is the true model that we would like to recover. Note that it is
a perfect fit because it is exactly the same error term in both
potential outcomes,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>U</mi><mn>0</mn></msub><mo>=</mo><msub><mi>U</mi><mn>1</mn></msub><mo>=</mo><mi>U</mi></mrow><annotation encoding="application/x-tex">U_0 = U_1 = U</annotation></semantics></math>.
If we had an additional error term but uncorrelated with the rest, we
would estimate the same coefficients (but with more noise).</p>
</div>
<div class="section level3">
<h3 id="naive-ols">Naive OLS<a class="anchor" aria-label="anchor" href="#naive-ols"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">naive_ols</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">d</span> <span class="op">+</span> <span class="va">w0</span> <span class="op">+</span> <span class="va">w1</span>, <span class="va">data</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">naive_ols</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = y ~ d + w0 + w1, data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -4.0776 -0.6767  0.0018  0.6924  3.9086 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  2.70023    0.01464  184.47   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; d            1.17707    0.02126   55.37   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; w0           0.28488    0.01068   26.66   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; w1           0.36167    0.01075   33.66   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 1.008 on 9996 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:   0.45,  Adjusted R-squared:  0.4498 </span></span>
<span><span class="co">#&gt; F-statistic:  2726 on 3 and 9996 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<p>Obviously, the naive OLS estimator is biased, because there is
endogeneity:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>U</mi><annotation encoding="application/x-tex">U</annotation></semantics></math>
is correlated with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math>.
It overestimates the effect of the treatment
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
to be 1. This is because individuals with high
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>U</mi><annotation encoding="application/x-tex">U</annotation></semantics></math>
both select themself more into
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">D=1</annotation></semantics></math>
and have a higher
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math>.
Indeed
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>U</mi><mo stretchy="false" form="prefix">|</mo><mi>D</mi><mo>=</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>&gt;</mo><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>U</mi><mo stretchy="false" form="prefix">|</mo><mi>D</mi><mo>=</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">E(U | D=1) &gt; E(U | D=0)</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>U</mi><annotation encoding="application/x-tex">U</annotation></semantics></math>
is negatively correlated with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math>
(cf the covariance parameter in <code>param_error</code>), so the higher
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>U</mi><annotation encoding="application/x-tex">U</annotation></semantics></math>,
the lower
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math>,
and the lower
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math>,
the more likely one is to select
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">D=1</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">U1</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">d</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">U0</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">d</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3521838</span></span>
<span><span class="co">#&gt; [1] -0.3516911</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="wrongly-assuming-that-the-semi-ivs-are-valid-ivs">Wrongly assuming that the semi-IVs are valid IVs<a class="anchor" aria-label="anchor" href="#wrongly-assuming-that-the-semi-ivs-are-valid-ivs"></a>
</h3>
<p>What is we assume that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>W</mi><mn>0</mn></msub><annotation encoding="application/x-tex">W_0</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>W</mi><mn>1</mn></msub><annotation encoding="application/x-tex">W_1</annotation></semantics></math>
are valid IVs (i.e., that they have no direct effect on their respective
potential outcomes)?</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://zeileis.github.io/ivreg/" class="external-link">ivreg</a></span><span class="op">)</span> <span class="co"># remark: ivreg is not required otherwise in semiivreg, only in this vignette. </span></span>
<span><span class="va">valid_iv</span> <span class="op">=</span> <span class="fu"><a href="https://zeileis.github.io/ivreg/reference/ivreg.html" class="external-link">ivreg</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">d</span> <span class="op">|</span> <span class="va">w0</span> <span class="op">+</span> <span class="va">w1</span> <span class="op">+</span> <span class="va">w0</span><span class="op">:</span><span class="va">w1</span>, data<span class="op">=</span><span class="va">data</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">valid_iv</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; ivreg(formula = y ~ d | w0 + w1 + w0:w1, data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -5.42133 -0.82741  0.01821  0.83379  4.51746 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  2.85027    0.04109   69.37   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; d            0.88099    0.07832   11.25   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Diagnostic tests:</span></span>
<span><span class="co">#&gt;                   df1  df2 statistic  p-value    </span></span>
<span><span class="co">#&gt; Weak instruments    3 9996    371.29  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; Wu-Hausman          1 9997     12.88 0.000333 ***</span></span>
<span><span class="co">#&gt; Sargan              2   NA   3268.63  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 1.24 on 9998 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-Squared: 0.1681,  Adjusted R-squared: 0.1681 </span></span>
<span><span class="co">#&gt; Wald test: 126.5 on 1 and 9998 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<p>The estimated coefficients is also completely biased here, because it
assumes the semi-IVs have no effect on the outcomes while they do.</p>
</div>
<div class="section level3">
<h3 id="semi-iv-estimation-with-semiivreg">semi-IV estimation with <code>semiivreg</code><a class="anchor" aria-label="anchor" href="#semi-iv-estimation-with-semiivreg"></a>
</h3>
<p>Let us now see how the semi-IV estimator performs. To specify the
estimation with homogenous treatment effects, we specify
<code>est_method="homogenous"</code>. This performs a sieve-like
estimation but with an additional constraint which restrict the MTE to
be constant by imposing constraints on the control function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>κ</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\kappa_0(p)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>κ</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\kappa_1(p)</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">semiiv</span> <span class="op">=</span> <span class="fu"><a href="../reference/semiivreg.html">semiivreg</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">d</span><span class="op">|</span><span class="va">w0</span><span class="op">|</span><span class="va">w1</span>, <span class="va">data</span>, est_method<span class="op">=</span><span class="st">"homogenous"</span>, plotting<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">summary_coeff</span> <span class="op">=</span> <span class="va">semiiv</span><span class="op">$</span><span class="va">estimate</span><span class="op">$</span><span class="va">est</span> <span class="co"># extract the coefficients from the homogenous TE specification</span></span>
<span><span class="va">summary_coeff</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,<span class="op">]</span> <span class="co"># only print the first 4 coefficients, the other correspond to the control function of P</span></span>
<span><span class="co">#&gt;      Variable  Estimate  Std_Error   t_value           p_value</span></span>
<span><span class="co">#&gt; 1 (Intercept) 3.2058476 0.03386160 94.675015 0.000000000000000</span></span>
<span><span class="co">#&gt; 2        I(d) 0.3890825 0.06510590  5.976149 0.000000002362833</span></span>
<span><span class="co">#&gt; 3 I(1 - d):w0 0.8029398 0.01191954 67.363298 0.000000000000000</span></span>
<span><span class="co">#&gt; 4     I(d):w1 0.4972506 0.01185955 41.928280 0.000000000000000</span></span>
<span><span class="va">true_param</span></span>
<span><span class="co">#&gt; [1] 3.2 0.4 0.8 0.5</span></span></code></pre></div>
<p>The estimated coefficients are very close to the truth, with
relatively small standard errors here, even though the sample size is
modest (10000 observations).</p>
<p>Be cautious though: the standard errors are computed <em>without</em>
taking into account the fact that the propensity score is estimated in a
first stage. We can correct this estimation with
<code><a href="../reference/semiivreg.html">semiivreg_boot()</a></code>. But typically, if the first stage is well
estimated, the bias in the standard errors is small, as visible
below.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">semiivboot</span> <span class="op">=</span> <span class="fu"><a href="../reference/semiivreg.html">semiivreg_boot</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">d</span><span class="op">|</span><span class="va">w0</span><span class="op">|</span><span class="va">w1</span>, <span class="va">data</span>, Nboot<span class="op">=</span><span class="fl">200</span>, est_method<span class="op">=</span><span class="st">"homogenous"</span>, plotting<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co"># reduce the number of bootstrap simulation for speed;  </span></span>
<span><span class="co">#&gt; Bandwidth and MTR/MTE estimation on main sample... </span></span>
<span><span class="co">#&gt; Estimating first stage... First stage estimated.       </span></span>
<span><span class="co">#&gt; 2nd stage: Estimating MTR and MTE... </span></span>
<span><span class="co">#&gt; Estimation complete.                                             </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Bandwidth and MTR/MTE estimation on main sample: Done. </span></span>
<span><span class="co">#&gt; Bootstrap Progress: 1/200 Bootstrap Progress: 2/200 Bootstrap Progress: 3/200 Bootstrap Progress: 4/200 Bootstrap Progress: 5/200 Bootstrap Progress: 6/200 Bootstrap Progress: 7/200 Bootstrap Progress: 8/200 Bootstrap Progress: 9/200 Bootstrap Progress: 10/200 Bootstrap Progress: 11/200 Bootstrap Progress: 12/200 Bootstrap Progress: 13/200 Bootstrap Progress: 14/200 Bootstrap Progress: 15/200 Bootstrap Progress: 16/200 Bootstrap Progress: 17/200 Bootstrap Progress: 18/200 Bootstrap Progress: 19/200 Bootstrap Progress: 20/200 Bootstrap Progress: 21/200 Bootstrap Progress: 22/200 Bootstrap Progress: 23/200 Bootstrap Progress: 24/200 Bootstrap Progress: 25/200 Bootstrap Progress: 26/200 Bootstrap Progress: 27/200 Bootstrap Progress: 28/200 Bootstrap Progress: 29/200 Bootstrap Progress: 30/200 Bootstrap Progress: 31/200 Bootstrap Progress: 32/200 Bootstrap Progress: 33/200 Bootstrap Progress: 34/200 Bootstrap Progress: 35/200 Bootstrap Progress: 36/200 Bootstrap Progress: 37/200 Bootstrap Progress: 38/200 Bootstrap Progress: 39/200 Bootstrap Progress: 40/200 Bootstrap Progress: 41/200 Bootstrap Progress: 42/200 Bootstrap Progress: 43/200 Bootstrap Progress: 44/200 Bootstrap Progress: 45/200 Bootstrap Progress: 46/200 Bootstrap Progress: 47/200 Bootstrap Progress: 48/200 Bootstrap Progress: 49/200 Bootstrap Progress: 50/200 Bootstrap Progress: 51/200 Bootstrap Progress: 52/200 Bootstrap Progress: 53/200 Bootstrap Progress: 54/200 Bootstrap Progress: 55/200 Bootstrap Progress: 56/200 Bootstrap Progress: 57/200 Bootstrap Progress: 58/200 Bootstrap Progress: 59/200 Bootstrap Progress: 60/200 Bootstrap Progress: 61/200 Bootstrap Progress: 62/200 Bootstrap Progress: 63/200 Bootstrap Progress: 64/200 Bootstrap Progress: 65/200 Bootstrap Progress: 66/200 Bootstrap Progress: 67/200 Bootstrap Progress: 68/200 Bootstrap Progress: 69/200 Bootstrap Progress: 70/200 Bootstrap Progress: 71/200 Bootstrap Progress: 72/200 Bootstrap Progress: 73/200 Bootstrap Progress: 74/200 Bootstrap Progress: 75/200 Bootstrap Progress: 76/200 Bootstrap Progress: 77/200 Bootstrap Progress: 78/200 Bootstrap Progress: 79/200 Bootstrap Progress: 80/200 Bootstrap Progress: 81/200 Bootstrap Progress: 82/200 Bootstrap Progress: 83/200 Bootstrap Progress: 84/200 Bootstrap Progress: 85/200 Bootstrap Progress: 86/200 Bootstrap Progress: 87/200 Bootstrap Progress: 88/200 Bootstrap Progress: 89/200 Bootstrap Progress: 90/200 Bootstrap Progress: 91/200 Bootstrap Progress: 92/200 Bootstrap Progress: 93/200 Bootstrap Progress: 94/200 Bootstrap Progress: 95/200 Bootstrap Progress: 96/200 Bootstrap Progress: 97/200 Bootstrap Progress: 98/200 Bootstrap Progress: 99/200 Bootstrap Progress: 100/200 Bootstrap Progress: 101/200 Bootstrap Progress: 102/200 Bootstrap Progress: 103/200 Bootstrap Progress: 104/200 Bootstrap Progress: 105/200 Bootstrap Progress: 106/200 Bootstrap Progress: 107/200 Bootstrap Progress: 108/200 Bootstrap Progress: 109/200 Bootstrap Progress: 110/200 Bootstrap Progress: 111/200 Bootstrap Progress: 112/200 Bootstrap Progress: 113/200 Bootstrap Progress: 114/200 Bootstrap Progress: 115/200 Bootstrap Progress: 116/200 Bootstrap Progress: 117/200 Bootstrap Progress: 118/200 Bootstrap Progress: 119/200 Bootstrap Progress: 120/200 Bootstrap Progress: 121/200 Bootstrap Progress: 122/200 Bootstrap Progress: 123/200 Bootstrap Progress: 124/200 Bootstrap Progress: 125/200 Bootstrap Progress: 126/200 Bootstrap Progress: 127/200 Bootstrap Progress: 128/200 Bootstrap Progress: 129/200 Bootstrap Progress: 130/200 Bootstrap Progress: 131/200 Bootstrap Progress: 132/200 Bootstrap Progress: 133/200 Bootstrap Progress: 134/200 Bootstrap Progress: 135/200 Bootstrap Progress: 136/200 Bootstrap Progress: 137/200 Bootstrap Progress: 138/200 Bootstrap Progress: 139/200 Bootstrap Progress: 140/200 Bootstrap Progress: 141/200 Bootstrap Progress: 142/200 Bootstrap Progress: 143/200 Bootstrap Progress: 144/200 Bootstrap Progress: 145/200 Bootstrap Progress: 146/200 Bootstrap Progress: 147/200 Bootstrap Progress: 148/200 Bootstrap Progress: 149/200 Bootstrap Progress: 150/200 Bootstrap Progress: 151/200 Bootstrap Progress: 152/200 Bootstrap Progress: 153/200 Bootstrap Progress: 154/200 Bootstrap Progress: 155/200 Bootstrap Progress: 156/200 Bootstrap Progress: 157/200 Bootstrap Progress: 158/200 Bootstrap Progress: 159/200 Bootstrap Progress: 160/200 Bootstrap Progress: 161/200 Bootstrap Progress: 162/200 Bootstrap Progress: 163/200 Bootstrap Progress: 164/200 Bootstrap Progress: 165/200 Bootstrap Progress: 166/200 Bootstrap Progress: 167/200 Bootstrap Progress: 168/200 Bootstrap Progress: 169/200 Bootstrap Progress: 170/200 Bootstrap Progress: 171/200 Bootstrap Progress: 172/200 Bootstrap Progress: 173/200 Bootstrap Progress: 174/200 Bootstrap Progress: 175/200 Bootstrap Progress: 176/200 Bootstrap Progress: 177/200 Bootstrap Progress: 178/200 Bootstrap Progress: 179/200 Bootstrap Progress: 180/200 Bootstrap Progress: 181/200 Bootstrap Progress: 182/200 Bootstrap Progress: 183/200 Bootstrap Progress: 184/200 Bootstrap Progress: 185/200 Bootstrap Progress: 186/200 Bootstrap Progress: 187/200 Bootstrap Progress: 188/200 Bootstrap Progress: 189/200 Bootstrap Progress: 190/200 Bootstrap Progress: 191/200 Bootstrap Progress: 192/200 Bootstrap Progress: 193/200 Bootstrap Progress: 194/200 Bootstrap Progress: 195/200 Bootstrap Progress: 196/200 Bootstrap Progress: 197/200 Bootstrap Progress: 198/200 Bootstrap Progress: 199/200 Bootstrap Progress: 200/200 </span></span>
<span><span class="va">boot_se</span> <span class="op">=</span> <span class="va">semiivboot</span><span class="op">$</span><span class="va">estimate</span><span class="op">$</span><span class="va">coeff</span><span class="op">$</span><span class="va">std_error</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span>
<span><span class="va">res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">summary_coeff</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="va">boot_se</span><span class="op">)</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Variable"</span>, <span class="st">"Estimate"</span>, <span class="st">"wrong analytic SE"</span>, <span class="st">"Bootstrapped SE"</span><span class="op">)</span></span>
<span><span class="va">res</span></span>
<span><span class="co">#&gt;      Variable  Estimate wrong analytic SE Bootstrapped SE</span></span>
<span><span class="co">#&gt; 1 (Intercept) 3.2058476        0.03386160      0.03462913</span></span>
<span><span class="co">#&gt; 2        I(d) 0.3890825        0.06510590      0.06628878</span></span>
<span><span class="co">#&gt; 3 I(1 - d):w0 0.8029398        0.01191954      0.01299299</span></span>
<span><span class="co">#&gt; 4     I(d):w1 0.4972506        0.01185955      0.01344433</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="alternative-semi-iv-strategy-based-on-iv-quantile-regression">Alternative semi-IV strategy: based on IV-quantile regression<a class="anchor" aria-label="anchor" href="#alternative-semi-iv-strategy-based-on-iv-quantile-regression"></a>
</h3>
<p>As described in <span class="citation">Bruneel-Zupanc (2024)</span>,
there is another general nonparametric identification strategy with
semi-IV, building on the IV-quantile regression (IVQR) framework of
<span class="citation">Chernozhukov and Hansen (2005)</span>. In the
model with homogenous treatment effect, this strategy requires that some
interaction
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>0</mn></msub><mo>×</mo><msub><mi>W</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">W_0 \times W_1</annotation></semantics></math>
is relevant for the selection into treatment. The intuition is that this
interaction now serves as IV for the treatment
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
within this framework. The nice feature of this strategy is that it can
be implemented with standard IV estimation, e.g., <code><a href="https://zeileis.github.io/ivreg/reference/ivreg.html" class="external-link">ivreg()</a></code>
in R.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">semiivqr</span> <span class="op">=</span> <span class="fu"><a href="https://zeileis.github.io/ivreg/reference/ivreg.html" class="external-link">ivreg</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">d</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">d</span><span class="op">)</span><span class="op">:</span><span class="va">w0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">:</span><span class="va">w1</span><span class="op">|</span><span class="va">w0</span><span class="op">+</span><span class="va">w1</span><span class="op">+</span><span class="va">w0</span><span class="op">:</span><span class="va">w1</span>, data<span class="op">=</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">semiivqr</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in printHypothesis(L, rhs, names(b)): one or more coefficients in the hypothesis include</span></span>
<span><span class="co">#&gt;      arithmetic operators in their names;</span></span>
<span><span class="co">#&gt;   the printed representation of the hypothesis will be omitted</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; ivreg(formula = y ~ d + I(1 - d):w0 + I(d):w1 | w0 + w1 + w0:w1, </span></span>
<span><span class="co">#&gt;     data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;       Min        1Q    Median        3Q       Max </span></span>
<span><span class="co">#&gt; -3.315219 -0.647210 -0.002237  0.644122  3.580389 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)   2.9539     0.8646   3.417 0.000637 ***</span></span>
<span><span class="co">#&gt; d             0.8944     1.7323   0.516 0.605655    </span></span>
<span><span class="co">#&gt; I(1 - d):w0   0.6523     0.5202   1.254 0.209907    </span></span>
<span><span class="co">#&gt; I(d):w1       0.6460     0.4998   1.293 0.196159    </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Diagnostic tests:</span></span>
<span><span class="co">#&gt;                                 df1  df2 statistic p-value    </span></span>
<span><span class="co">#&gt; Weak instruments (d)              3 9996    371.29  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Weak instruments (I(1 - d):w0)    3 9996   3228.13  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Weak instruments (I(d):w1)        3 9996   3503.39  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Wu-Hausman                        3 9993     46.22  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Sargan                            0   NA        NA      NA    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.9535 on 9996 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-Squared: 0.5082,  Adjusted R-squared: 0.5081 </span></span>
<span><span class="co">#&gt; Wald test:  1914 on 3 and 9996 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<p>In this baseline model, the interaction is not significant in the
first stage, so we have a problem of weak IVs. This is not the case in
this baseline model, so the estimation blow up because the IV is
irrelevant.</p>
<p>However, if we specify an alternative model where the interaction is
indeed relevant, we will also estimate correctly the homogenous
treatment effect using this strategy. This is what we do now.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Model 2</span></span>
<span><span class="va">N</span> <span class="op">=</span> <span class="fl">10000</span>; <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">model_type</span> <span class="op">=</span> <span class="st">"homogenous"</span></span>
<span><span class="va">param_error</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1.5</span>, <span class="op">-</span><span class="fl">0.6</span><span class="op">)</span> <span class="co"># var_u, var_v, cov_uv # if homogenous</span></span>
<span><span class="va">param_Z</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1.5</span>, <span class="fl">1.5</span>, <span class="fl">0.9</span><span class="op">)</span> <span class="co"># meanW0 state0, meanW1 state0, meanW0 state1, meanW1 state1, varW0, varW1, covW0W1</span></span>
<span><span class="va">param_p</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.3</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># constant, alphaW0, alphaW1, alphaW0W1, effect of state, effect of parent educ</span></span>
<span><span class="va">param_y0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.2</span>, <span class="fl">0.8</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># intercept, effect of Wd, effect of state, effect of parent educ;</span></span>
<span><span class="va">param_y1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.2</span><span class="op">+</span><span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># the +0.2 = Average treatment effect; effect of W1, effect of state, effect of parent educ;</span></span>
<span><span class="va">param_genX</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span> <span class="co"># probability state=1 (instead of 0), mean_parenteduc, sd_parenteduc (parenteduc drawn as continuous)</span></span>
<span></span>
<span><span class="va">data2</span> <span class="op">=</span> <span class="fu"><a href="../reference/simul_data.html">simul_data</a></span><span class="op">(</span><span class="va">N</span>, <span class="va">model_type</span>, <span class="va">param_y0</span>, <span class="va">param_y1</span>, <span class="va">param_p</span>, <span class="va">param_Z</span>, <span class="va">param_genX</span>, <span class="va">param_error</span><span class="op">)</span></span></code></pre></div>
<p>This is a model <code>param_p[4]</code> gives the effect of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>0</mn></msub><mo>×</mo><msub><mi>W</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">W_0\times W_1</annotation></semantics></math>
on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>.
It is different from 0 here. So the IVQR strategy should work.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">semiivqr2</span> <span class="op">=</span> <span class="fu"><a href="https://zeileis.github.io/ivreg/reference/ivreg.html" class="external-link">ivreg</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">d</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">d</span><span class="op">)</span><span class="op">:</span><span class="va">w0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">:</span><span class="va">w1</span><span class="op">|</span><span class="va">w0</span><span class="op">+</span><span class="va">w1</span><span class="op">+</span><span class="va">w0</span><span class="op">:</span><span class="va">w1</span>, data<span class="op">=</span><span class="va">data2</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">semiivqr2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in printHypothesis(L, rhs, names(b)): one or more coefficients in the hypothesis include</span></span>
<span><span class="co">#&gt;      arithmetic operators in their names;</span></span>
<span><span class="co">#&gt;   the printed representation of the hypothesis will be omitted</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; ivreg(formula = y ~ d + I(1 - d):w0 + I(d):w1 | w0 + w1 + w0:w1, </span></span>
<span><span class="co">#&gt;     data = data2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;       Min        1Q    Median        3Q       Max </span></span>
<span><span class="co">#&gt; -3.611960 -0.676872 -0.003606  0.669898  3.886447 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value  Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  3.21013    0.03615  88.811   &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; d            0.37626    0.08777   4.287 0.0000183 ***</span></span>
<span><span class="co">#&gt; I(1 - d):w0  0.80317    0.01516  52.976   &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; I(d):w1      0.49653    0.04179  11.882   &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Diagnostic tests:</span></span>
<span><span class="co">#&gt;                                 df1  df2 statistic p-value    </span></span>
<span><span class="co">#&gt; Weak instruments (d)              3 9996    405.38  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Weak instruments (I(1 - d):w0)    3 9996   8024.23  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Weak instruments (I(d):w1)        3 9996   1676.42  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Wu-Hausman                        3 9993     50.75  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Sargan                            0   NA        NA      NA    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 1.005 on 9996 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-Squared: 0.4829,  Adjusted R-squared: 0.4828 </span></span>
<span><span class="co">#&gt; Wald test:  2101 on 3 and 9996 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<p>Indeed, it estimates the coefficients well. Notice that the
<code><a href="../reference/semiivreg.html">semiivreg()</a></code> function also works there:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">semiiv2</span> <span class="op">=</span> <span class="fu"><a href="../reference/semiivreg.html">semiivreg</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">d</span><span class="op">|</span><span class="va">w0</span><span class="op">|</span><span class="va">w1</span>, data<span class="op">=</span><span class="va">data2</span>, est_method<span class="op">=</span><span class="st">"homogenous"</span>, plotting<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">summary_coeff2</span> <span class="op">=</span> <span class="va">semiiv2</span><span class="op">$</span><span class="va">estimate</span><span class="op">$</span><span class="va">est</span> <span class="co"># extract the coefficients from the homogenous TE specification</span></span>
<span><span class="va">summary_coeff2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,<span class="op">]</span> <span class="co"># only print the first 4 coefficients, the other correspond to the control function of P</span></span>
<span><span class="co">#&gt;      Variable  Estimate  Std_Error  t_value       p_value</span></span>
<span><span class="co">#&gt; 1 (Intercept) 3.2053784 0.04084850 78.46991  0.000000e+00</span></span>
<span><span class="co">#&gt; 2        I(d) 0.3868430 0.09585951  4.03552  5.488775e-05</span></span>
<span><span class="co">#&gt; 3 I(1 - d):w0 0.8048831 0.00960523 83.79634  0.000000e+00</span></span>
<span><span class="co">#&gt; 4     I(d):w1 0.5004888 0.01866240 26.81803 4.784644e-153</span></span>
<span><span class="va">true_param</span></span>
<span><span class="co">#&gt; [1] 3.2 0.4 0.8 0.5</span></span></code></pre></div>
<p>Thus <code><a href="../reference/semiivreg.html">semiivreg()</a></code>is more flexible and should be used in
any case. Notice that, in general the IVQR estimation will also have a
higher variance of the estimate because it builds on the interaction as
an IV so it requires it to have a large significant effects on the
treatment to avoid weak IV concerns. While the <code><a href="../reference/semiivreg.html">semiivreg()</a></code>
only relies on the fact that each semi-IV is relevant by itself, which
is relatively easier to satisfy. Especially if the semi-IVs have a
strong impact on their respective potential outcome, they should be
relevant as soon as there is selection into treatment based on gains
(i.e.,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mn>1</mn></msub><mo>−</mo><msub><mi>Y</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">Y_1 - Y_0</annotation></semantics></math>).</p>
<p>Remark: since we know the first stage includes the interaction, we
might as well include it in semiivreg as follows (but the previous
results not including where still ok, despite the bias in prediction of
the propensity score because of the wrong formula)</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">semiiv3</span> <span class="op">=</span> <span class="fu"><a href="../reference/semiivreg.html">semiivreg</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">d</span><span class="op">|</span><span class="va">w0</span><span class="op">|</span><span class="va">w1</span>, propensity_formula <span class="op">=</span> <span class="va">d</span><span class="op">~</span><span class="va">w0</span><span class="op">+</span><span class="va">w1</span><span class="op">+</span><span class="va">w0</span><span class="op">:</span><span class="va">w1</span>, </span>
<span>                    data<span class="op">=</span><span class="va">data2</span>, est_method<span class="op">=</span><span class="st">"homogenous"</span>, plotting<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">fstage</span> <span class="op">=</span> <span class="va">semiiv3</span><span class="op">$</span><span class="va">estimate</span><span class="op">$</span><span class="va">propensity</span>; <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fstage</span><span class="op">)</span> <span class="co"># returns the first stage estimation</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; glm(formula = propensity_formula, family = binomial(link = "probit"), </span></span>
<span><span class="co">#&gt;     data = propensity_data, weights = WEIGHTS)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; (Intercept) -0.02004    0.01483  -1.351    0.177    </span></span>
<span><span class="co">#&gt; w0           0.24314    0.01391  17.475   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; w1          -0.32813    0.01424 -23.043   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; w0:w1       -0.23864    0.01014 -23.535   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Null deviance: 13620  on 9999  degrees of freedom</span></span>
<span><span class="co">#&gt; Residual deviance: 12366  on 9996  degrees of freedom</span></span>
<span><span class="co">#&gt; AIC: 12374</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of Fisher Scoring iterations: 4</span></span>
<span><span class="va">summary_coeff3</span> <span class="op">=</span> <span class="va">semiiv3</span><span class="op">$</span><span class="va">estimate</span><span class="op">$</span><span class="va">est</span> <span class="co"># extract the coefficients from the homogenous TE specification</span></span>
<span><span class="va">summary_coeff3</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,<span class="op">]</span> <span class="co"># only print the first 4 coefficients, the other correspond to the control function of P</span></span>
<span><span class="co">#&gt;      Variable  Estimate   Std_Error    t_value       p_value</span></span>
<span><span class="co">#&gt; 1 (Intercept) 3.2071842 0.027427671 116.932429  0.000000e+00</span></span>
<span><span class="co">#&gt; 2        I(d) 0.3847556 0.061775953   6.228242  4.906916e-10</span></span>
<span><span class="co">#&gt; 3 I(1 - d):w0 0.8032558 0.009526755  84.315781  0.000000e+00</span></span>
<span><span class="co">#&gt; 4     I(d):w1 0.5013325 0.015732198  31.866653 2.577489e-212</span></span>
<span><span class="va">true_param</span></span>
<span><span class="co">#&gt; [1] 3.2 0.4 0.8 0.5</span></span></code></pre></div>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-bruneel2024" class="csl-entry">
Bruneel-Zupanc, Christophe. 2024. <span>“Don’t (Fully) Exclude Me, It’s
Not Necessary! Identification with Semi-IVs.”</span> <a href="https://arxiv.org/abs/2303.12667" class="external-link">https://arxiv.org/abs/2303.12667</a>.
</div>
<div id="ref-chernozhukov2005iv" class="csl-entry">
Chernozhukov, Victor, and Christian Hansen. 2005. <span>“An IV Model of
Quantile Treatment Effects.”</span> <em>Econometrica</em> 73 (1):
245–61.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christophe Bruneel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
