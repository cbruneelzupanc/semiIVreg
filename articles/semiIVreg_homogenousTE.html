<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Estimator Performance: homogenous treatment effect model • semiIVreg</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Estimator Performance: homogenous treatment effect model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">semiIVreg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/semiIVreg.html">Model and Guidelines</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-more" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">More</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-more">
<li><a class="dropdown-item" href="../articles/semiIVreg_homogenousTE.html">Estimation with Homogenous Treatment Effect</a></li>
    <li><a class="dropdown-item" href="../articles/semiIVreg_heterogenousTE.html">Estimation with general Heterogenous Treatment Effect</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/CBruneelZupanc" aria-label="Twitter"><span class="fa fa-twitter"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cbruneelzupanc/semiIVreg" aria-label="Github"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Estimator Performance: homogenous treatment effect model</h1>
                        <h4 data-toc-skip class="author"><a href="https://www.cbruneel.com/" class="external-link">Christophe Bruneel-Zupanc</a></h4>
            
            <h4 data-toc-skip class="date">Last modified:
2024-07-22</h4>
      

      <div class="d-none name"><code>semiIVreg_homogenousTE.Rmd</code></div>
    </div>

    
    
<p>Let us compare the performance of the semi-IV estimator under
different violation of the standard IV assumptions. This note mimics the
Appendix on <span class="citation">Bruneel-Zupanc (2024)</span>.</p>
<div class="section level2">
<h2 id="simulating-data">Simulating data<a class="anchor" aria-label="anchor" href="#simulating-data"></a>
</h2>
<p>We simulate generalized Roy models using the
<code><a href="../reference/simul_data.html">simul_data()</a></code>function. See the documentation of the function
for details about the model. Depending on the chosen parameters, we can
simulate a model with homogenous/heterogenous treatment effects, as well
as with valid IVs eventually. That’s what we will do here. In every
simulation we do not include covariates (set all their effect to 0), but
these can be easily included.</p>
</div>
<div class="section level2">
<h2 id="model-with-homogenous-treatment-effects">Model with homogenous treatment effects<a class="anchor" aria-label="anchor" href="#model-with-homogenous-treatment-effects"></a>
</h2>
<div class="section level3">
<h3 id="simulate-data">Simulate data<a class="anchor" aria-label="anchor" href="#simulate-data"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Model 1</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.cbruneel.com/" class="external-link">semiIVreg</a></span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">=</span> <span class="fl">10000</span>; <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">model_type</span> <span class="op">=</span> <span class="st">"homogenous"</span></span>
<span><span class="va">param_error</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1.5</span>, <span class="op">-</span><span class="fl">0.6</span><span class="op">)</span> <span class="co"># var_u, var_v, cov_uv # if homogenous</span></span>
<span><span class="va">param_Z</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1.5</span>, <span class="fl">1.5</span>, <span class="fl">0.9</span><span class="op">)</span> <span class="co"># meanW0 state0, meanW1 state0, meanW0 state1, meanW1 state1, varW0, varW1, covW0W1</span></span>
<span><span class="va">param_p</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># constant, alphaW0, alphaW1, alphaW0W1, effect of state, effect of parent educ</span></span>
<span><span class="va">param_y0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.2</span>, <span class="fl">0.8</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># intercept, effect of Wd, effect of state, effect of parent educ;</span></span>
<span><span class="va">param_y1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.2</span><span class="op">+</span><span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># the +0.2 = Average treatment effect; effect of W1, effect of state, effect of parent educ;</span></span>
<span><span class="va">param_genX</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span> <span class="co"># probability state=1 (instead of 0), mean_parenteduc, sd_parenteduc (parenteduc drawn as continuous)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="../reference/simul_data.html">simul_data</a></span><span class="op">(</span><span class="va">N</span>, <span class="va">model_type</span>, <span class="va">param_y0</span>, <span class="va">param_y1</span>, <span class="va">param_p</span>, <span class="va">param_Z</span>, <span class="va">param_genX</span>, <span class="va">param_error</span><span class="op">)</span></span></code></pre></div>
<p>This is a model with homogenous Treatment Effects (conditional on
<span class="math inline">\(W_0, W_1\)</span>).</p>
</div>
<div class="section level3">
<h3 id="true-unobserved-homogenous-treatment-effects">True unobserved homogenous Treatment Effects<a class="anchor" aria-label="anchor" href="#true-unobserved-homogenous-treatment-effects"></a>
</h3>
<p>Here, at <span class="math inline">\((W_0, W_1) = (0, 0)\)</span>,
the effect is always 0.4 (see the parameters). To see this, let us just
use the true <em>unobserved</em> potential outcomes (only observed
thanks to the simulation).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span><span class="op">$</span><span class="va">true_TE</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">y1</span> <span class="op">-</span> <span class="va">data</span><span class="op">$</span><span class="va">y0</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">true_TE</span> <span class="op">~</span> <span class="va">w0</span> <span class="op">+</span> <span class="va">w1</span>, <span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in summary.lm(lm(true_TE ~ w0 + w1, data)): essentially perfect fit:</span></span>
<span><span class="co">#&gt; summary may be unreliable</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = true_TE ~ w0 + w1, data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;        Min         1Q     Median         3Q        Max </span></span>
<span><span class="co">#&gt; -1.324e-14 -2.111e-16  3.000e-19  2.120e-16  1.050e-14 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;               Estimate Std. Error    t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  4.000e-01  3.859e-18  1.037e+17   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; w0          -8.000e-01  3.920e-18 -2.041e+17   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; w1           5.000e-01  3.939e-18  1.269e+17   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 3.859e-16 on 9997 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:      1,  Adjusted R-squared:      1 </span></span>
<span><span class="co">#&gt; F-statistic: 2.084e+34 on 2 and 9997 DF,  p-value: &lt; 2.2e-16</span></span>
<span><span class="va">true_param</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">param_y0</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">param_y1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">param_y0</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">param_y0</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">param_y1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>; <span class="va">true_param</span></span>
<span><span class="co">#&gt; [1] 3.2 0.4 0.8 0.5</span></span>
<span><span class="co"># constant y0, constant y1 - constant y0, effects of w0 on y0, effects of w1 on y1.</span></span></code></pre></div>
<p>This is the true model that we would like to recover. Note that it is
a perfect fit because it is exactly the same error term in both
potential outcomes, <span class="math inline">\(U_0 = U_1 = U\)</span>.
If we had an additional error term but uncorrelated with the rest, we
would estimate the same coefficients (but with more noise).</p>
</div>
<div class="section level3">
<h3 id="naive-ols">Naive OLS<a class="anchor" aria-label="anchor" href="#naive-ols"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">naive_ols</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">d</span> <span class="op">+</span> <span class="va">w0</span> <span class="op">+</span> <span class="va">w1</span>, <span class="va">data</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">naive_ols</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = y ~ d + w0 + w1, data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -4.0776 -0.6767  0.0018  0.6924  3.9086 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  2.70023    0.01464  184.47   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; d            1.17707    0.02126   55.37   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; w0           0.28488    0.01068   26.66   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; w1           0.36167    0.01075   33.66   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 1.008 on 9996 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:   0.45,  Adjusted R-squared:  0.4498 </span></span>
<span><span class="co">#&gt; F-statistic:  2726 on 3 and 9996 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<p>Obviously, the naive OLS estimator is biased, because there is
endogeneity: <span class="math inline">\(U\)</span> is correlated with
<span class="math inline">\(D\)</span> and <span class="math inline">\(Y\)</span>. It overestimates the effect of the
treatment <span class="math inline">\(D\)</span> to be 1. This is
because individuals with high <span class="math inline">\(U\)</span>
both select themself more into <span class="math inline">\(D=1\)</span>
and have a higher <span class="math inline">\(Y\)</span>. Indeed <span class="math inline">\(E(U | D=1) &gt; E(U | D=0)\)</span>, and <span class="math inline">\(U\)</span> is negatively correlated with <span class="math inline">\(V\)</span> (cf the covariance parameter in
<code>param_error</code>), so the higher <span class="math inline">\(U\)</span>, the lower <span class="math inline">\(V\)</span>, and the lower <span class="math inline">\(V\)</span>, the more likely one is to select <span class="math inline">\(D=1\)</span>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">U1</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">d</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">U0</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">d</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3521838</span></span>
<span><span class="co">#&gt; [1] -0.3516911</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="wrongly-assuming-that-the-semi-ivs-are-valid-ivs">Wrongly assuming that the semi-IVs are valid IVs<a class="anchor" aria-label="anchor" href="#wrongly-assuming-that-the-semi-ivs-are-valid-ivs"></a>
</h3>
<p>What is we assume that <span class="math inline">\(W_0\)</span> and
<span class="math inline">\(W_1\)</span> are valid IVs (i.e., that they
have no direct effect on their respective potential outcomes)?</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://zeileis.github.io/ivreg/" class="external-link">ivreg</a></span><span class="op">)</span> <span class="co"># remark: ivreg is not required otherwise in semiivreg, only in this vignette. </span></span>
<span><span class="va">valid_iv</span> <span class="op">=</span> <span class="fu"><a href="https://zeileis.github.io/ivreg/reference/ivreg.html" class="external-link">ivreg</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">d</span> <span class="op">|</span> <span class="va">w0</span> <span class="op">+</span> <span class="va">w1</span> <span class="op">+</span> <span class="va">w0</span><span class="op">:</span><span class="va">w1</span>, data<span class="op">=</span><span class="va">data</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">valid_iv</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; ivreg(formula = y ~ d | w0 + w1 + w0:w1, data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -5.42133 -0.82741  0.01821  0.83379  4.51746 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  2.85027    0.04109   69.37   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; d            0.88099    0.07832   11.25   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Diagnostic tests:</span></span>
<span><span class="co">#&gt;                   df1  df2 statistic  p-value    </span></span>
<span><span class="co">#&gt; Weak instruments    3 9996    371.29  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; Wu-Hausman          1 9997     12.88 0.000333 ***</span></span>
<span><span class="co">#&gt; Sargan              2   NA   3268.63  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 1.24 on 9998 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-Squared: 0.1681,  Adjusted R-squared: 0.1681 </span></span>
<span><span class="co">#&gt; Wald test: 126.5 on 1 and 9998 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<p>The estimated coefficients is also completely biased here, because it
assumes the semi-IVs have no effect on the outcomes while they do.</p>
</div>
<div class="section level3">
<h3 id="semi-iv-estimation-with-semiivreg">semi-IV estimation with <code>semiivreg</code><a class="anchor" aria-label="anchor" href="#semi-iv-estimation-with-semiivreg"></a>
</h3>
<p>Let us now see how the semi-IV estimator performs.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">semiiv</span> <span class="op">=</span> <span class="fu"><a href="../reference/semiivreg.html">semiivreg</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">d</span><span class="op">|</span><span class="va">w0</span><span class="op">|</span><span class="va">w1</span>, <span class="va">data</span>, plotting<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">semiiv_homogenous</span> <span class="op">=</span> <span class="va">semiiv</span><span class="op">$</span><span class="va">estimate</span><span class="op">$</span><span class="va">est_homogenous</span> <span class="co"># extract the coefficients from the homogenous TE specification</span></span>
<span><span class="va">summary_coeff</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">semiiv_homogenous</span><span class="op">)</span></span>
<span><span class="va">summary_coeff</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,<span class="op">]</span> <span class="co"># only print the first 4 coefficients, the other correspond to the control function of P</span></span>
<span><span class="co">#&gt;              Estimate Std. Error   t value          Pr(&gt;|t|)</span></span>
<span><span class="co">#&gt; (Intercept) 3.2058476 0.03396914 94.375286 0.000000000000000</span></span>
<span><span class="co">#&gt; I(d)        0.3890825 0.06534782  5.954025 0.000000002704391</span></span>
<span><span class="co">#&gt; I(1 - d):w0 0.8029398 0.01193786 67.259916 0.000000000000000</span></span>
<span><span class="co">#&gt; I(d):w1     0.4972506 0.01178864 42.180500 0.000000000000000</span></span>
<span><span class="va">true_param</span></span>
<span><span class="co">#&gt; [1] 3.2 0.4 0.8 0.5</span></span></code></pre></div>
<p>The estimated coefficients are very close to the truth, with
relatively small standard errors here, even though the sample size is
modest (10000 observations).</p>
<p>Be cautious though: the standard errors are computed <em>without</em>
taking into account the fact that the propensity score is estimated in a
first stage. We can correct this estimation with
<code><a href="../reference/semiivreg.html">semiivreg_boot()</a></code>. But typically, if the first stage is well
estimated, the bias in the standard errors is small, as visible
below.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">semiivboot</span> <span class="op">=</span> <span class="fu"><a href="../reference/semiivreg.html">semiivreg_boot</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">d</span><span class="op">|</span><span class="va">w0</span><span class="op">|</span><span class="va">w1</span>, <span class="va">data</span>, Nboot<span class="op">=</span><span class="fl">500</span>, plotting<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co"># reduce the number of bootstrap simulation for speed;  </span></span>
<span><span class="va">boot_se</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">semiivboot</span><span class="op">$</span><span class="va">estimate</span><span class="op">$</span><span class="va">vcov_homogenous</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span>
<span><span class="va">res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">summary_coeff</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="va">boot_se</span><span class="op">)</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Estimate"</span>, <span class="st">"wrong analytic SE"</span>, <span class="st">"Bootstrapped SE"</span><span class="op">)</span></span>
<span><span class="va">res</span></span>
<span><span class="co">#&gt;              Estimate wrong analytic SE Bootstrapped SE</span></span>
<span><span class="co">#&gt; (Intercept) 3.2058476        0.03396914      0.03717139</span></span>
<span><span class="co">#&gt; I(d)        0.3890825        0.06534782      0.07168443</span></span>
<span><span class="co">#&gt; I(1 - d):w0 0.8029398        0.01193786      0.01322776</span></span>
<span><span class="co">#&gt; I(d):w1     0.4972506        0.01178864      0.01260633</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="alternative-semi-iv-strategy-based-on-iv-quantile-regression">Alternative semi-IV strategy: based on IV-quantile regression<a class="anchor" aria-label="anchor" href="#alternative-semi-iv-strategy-based-on-iv-quantile-regression"></a>
</h3>
<p>As described in <span class="citation">Bruneel-Zupanc (2024)</span>,
there is another general nonparametric identification strategy with
semi-IV, building on the IV-quantile regression (IVQR) framework of
<span class="citation">Chernozhukov and Hansen (2005)</span>. In the
model with homogenous treatment effect, this strategy requires that some
interaction <span class="math inline">\(W_0 \times W_1\)</span> is
relevant for the selection into treatment. The intuition is that this
interaction now serves as IV for the treatment <span class="math inline">\(D\)</span> within this framework. The nice feature
of this strategy is that it can be implemented with standard IV
estimation, e.g., <code><a href="https://zeileis.github.io/ivreg/reference/ivreg.html" class="external-link">ivreg()</a></code> in R.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">semiivqr</span> <span class="op">=</span> <span class="fu"><a href="https://zeileis.github.io/ivreg/reference/ivreg.html" class="external-link">ivreg</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">d</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">d</span><span class="op">)</span><span class="op">:</span><span class="va">w0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">:</span><span class="va">w1</span><span class="op">|</span><span class="va">w0</span><span class="op">+</span><span class="va">w1</span><span class="op">+</span><span class="va">w0</span><span class="op">:</span><span class="va">w1</span>, data<span class="op">=</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">semiivqr</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in printHypothesis(L, rhs, names(b)): one or more coefficients in the hypothesis include</span></span>
<span><span class="co">#&gt;      arithmetic operators in their names;</span></span>
<span><span class="co">#&gt;   the printed representation of the hypothesis will be omitted</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; ivreg(formula = y ~ d + I(1 - d):w0 + I(d):w1 | w0 + w1 + w0:w1, </span></span>
<span><span class="co">#&gt;     data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;       Min        1Q    Median        3Q       Max </span></span>
<span><span class="co">#&gt; -3.315219 -0.647210 -0.002237  0.644122  3.580389 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)   2.9539     0.8646   3.417 0.000637 ***</span></span>
<span><span class="co">#&gt; d             0.8944     1.7323   0.516 0.605655    </span></span>
<span><span class="co">#&gt; I(1 - d):w0   0.6523     0.5202   1.254 0.209907    </span></span>
<span><span class="co">#&gt; I(d):w1       0.6460     0.4998   1.293 0.196159    </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Diagnostic tests:</span></span>
<span><span class="co">#&gt;                                 df1  df2 statistic p-value    </span></span>
<span><span class="co">#&gt; Weak instruments (d)              3 9996    371.29  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Weak instruments (I(1 - d):w0)    3 9996   3228.13  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Weak instruments (I(d):w1)        3 9996   3503.39  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Wu-Hausman                        3 9993     46.22  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Sargan                            0   NA        NA      NA    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.9535 on 9996 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-Squared: 0.5082,  Adjusted R-squared: 0.5081 </span></span>
<span><span class="co">#&gt; Wald test:  1914 on 3 and 9996 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<p>In this baseline model, the interaction is not significant in the
first stage, so we have a problem of weak IVs. This is not the case in
this baseline model, so the estimation blow up because the IV is
irrelevant.</p>
<p>However, if we specify an alternative model where the interaction is
indeed relevant, we will also estimate correctly the homogenous
treatment effect using this strategy. This is what we do now.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Model 2</span></span>
<span><span class="va">N</span> <span class="op">=</span> <span class="fl">10000</span>; <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">model_type</span> <span class="op">=</span> <span class="st">"homogenous"</span></span>
<span><span class="va">param_error</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1.5</span>, <span class="op">-</span><span class="fl">0.6</span><span class="op">)</span> <span class="co"># var_u, var_v, cov_uv # if homogenous</span></span>
<span><span class="va">param_Z</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1.5</span>, <span class="fl">1.5</span>, <span class="fl">0.9</span><span class="op">)</span> <span class="co"># meanW0 state0, meanW1 state0, meanW0 state1, meanW1 state1, varW0, varW1, covW0W1</span></span>
<span><span class="va">param_p</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.3</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># constant, alphaW0, alphaW1, alphaW0W1, effect of state, effect of parent educ</span></span>
<span><span class="va">param_y0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.2</span>, <span class="fl">0.8</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># intercept, effect of Wd, effect of state, effect of parent educ;</span></span>
<span><span class="va">param_y1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.2</span><span class="op">+</span><span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># the +0.2 = Average treatment effect; effect of W1, effect of state, effect of parent educ;</span></span>
<span><span class="va">param_genX</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span> <span class="co"># probability state=1 (instead of 0), mean_parenteduc, sd_parenteduc (parenteduc drawn as continuous)</span></span>
<span></span>
<span><span class="va">data2</span> <span class="op">=</span> <span class="fu"><a href="../reference/simul_data.html">simul_data</a></span><span class="op">(</span><span class="va">N</span>, <span class="va">model_type</span>, <span class="va">param_y0</span>, <span class="va">param_y1</span>, <span class="va">param_p</span>, <span class="va">param_Z</span>, <span class="va">param_genX</span>, <span class="va">param_error</span><span class="op">)</span></span></code></pre></div>
<p>This is a model <code>param_p[4]</code> gives the effect of <span class="math inline">\(W_0\times W_1\)</span> on <span class="math inline">\(D\)</span>. It is different from 0 here. So the
IVQR strategy should work.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">semiivqr2</span> <span class="op">=</span> <span class="fu"><a href="https://zeileis.github.io/ivreg/reference/ivreg.html" class="external-link">ivreg</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">d</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">d</span><span class="op">)</span><span class="op">:</span><span class="va">w0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">:</span><span class="va">w1</span><span class="op">|</span><span class="va">w0</span><span class="op">+</span><span class="va">w1</span><span class="op">+</span><span class="va">w0</span><span class="op">:</span><span class="va">w1</span>, data<span class="op">=</span><span class="va">data2</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">semiivqr2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in printHypothesis(L, rhs, names(b)): one or more coefficients in the hypothesis include</span></span>
<span><span class="co">#&gt;      arithmetic operators in their names;</span></span>
<span><span class="co">#&gt;   the printed representation of the hypothesis will be omitted</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; ivreg(formula = y ~ d + I(1 - d):w0 + I(d):w1 | w0 + w1 + w0:w1, </span></span>
<span><span class="co">#&gt;     data = data2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;       Min        1Q    Median        3Q       Max </span></span>
<span><span class="co">#&gt; -3.611960 -0.676872 -0.003606  0.669898  3.886447 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value  Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  3.21013    0.03615  88.811   &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; d            0.37626    0.08777   4.287 0.0000183 ***</span></span>
<span><span class="co">#&gt; I(1 - d):w0  0.80317    0.01516  52.976   &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; I(d):w1      0.49653    0.04179  11.882   &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Diagnostic tests:</span></span>
<span><span class="co">#&gt;                                 df1  df2 statistic p-value    </span></span>
<span><span class="co">#&gt; Weak instruments (d)              3 9996    405.38  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Weak instruments (I(1 - d):w0)    3 9996   8024.23  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Weak instruments (I(d):w1)        3 9996   1676.42  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Wu-Hausman                        3 9993     50.75  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Sargan                            0   NA        NA      NA    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 1.005 on 9996 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-Squared: 0.4829,  Adjusted R-squared: 0.4828 </span></span>
<span><span class="co">#&gt; Wald test:  2101 on 3 and 9996 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<p>Indeed, it estimates the coefficients well. Notice that the
<code><a href="../reference/semiivreg.html">semiivreg()</a></code> function also works there:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">semiiv2</span> <span class="op">=</span> <span class="fu"><a href="../reference/semiivreg.html">semiivreg</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">d</span><span class="op">|</span><span class="va">w0</span><span class="op">|</span><span class="va">w1</span>, data<span class="op">=</span><span class="va">data2</span>, plotting<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">semiiv2_homogenous</span> <span class="op">=</span> <span class="va">semiiv2</span><span class="op">$</span><span class="va">estimate</span><span class="op">$</span><span class="va">est_homogenous</span> <span class="co"># extract the coefficients from the homogenous TE specification</span></span>
<span><span class="va">summary_coeff2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">semiiv2_homogenous</span><span class="op">)</span></span>
<span><span class="va">summary_coeff2</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,<span class="op">]</span> <span class="co"># only print the first 4 coefficients, the other correspond to the control function of P</span></span>
<span><span class="co">#&gt;              Estimate  Std. Error   t value      Pr(&gt;|t|)</span></span>
<span><span class="co">#&gt; (Intercept) 3.2053784 0.040632729 78.886614  0.000000e+00</span></span>
<span><span class="co">#&gt; I(d)        0.3868430 0.095396241  4.055117  5.048965e-05</span></span>
<span><span class="co">#&gt; I(1 - d):w0 0.8048831 0.009214952 87.345333  0.000000e+00</span></span>
<span><span class="co">#&gt; I(d):w1     0.5004888 0.018689574 26.779040 1.270063e-152</span></span>
<span><span class="va">true_param</span></span>
<span><span class="co">#&gt; [1] 3.2 0.4 0.8 0.5</span></span></code></pre></div>
<p>Thus <code><a href="../reference/semiivreg.html">semiivreg()</a></code>is more flexible and should be used in
any case. Notice that, in general the IVQR estimation will also have a
higher variance of the estimate because it builds on the interaction as
an IV so it requires it to have a large significant effects on the
treatment to avoid weak IV concerns. While the <code><a href="../reference/semiivreg.html">semiivreg()</a></code>
only relies on the fact that each semi-IV is relevant by itself, which
is relatively easier to satisfy. Especially if the semi-IVs have a
strong impact on their respective potential outcome, they should be
relevant as soon as there is selection into treatment based on gains
(i.e., <span class="math inline">\(Y_1 - Y_0\)</span>).</p>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-bruneel2024" class="csl-entry">
Bruneel-Zupanc, Christophe. 2024. <span>“Don’t (Fully) Exclude Me, It’s
Not Necessary! Identification with Semi-IVs.”</span> <a href="https://arxiv.org/abs/2303.12667" class="external-link">https://arxiv.org/abs/2303.12667</a>.
</div>
<div id="ref-chernozhukov2005iv" class="csl-entry">
Chernozhukov, Victor, and Christian Hansen. 2005. <span>“An IV Model of
Quantile Treatment Effects.”</span> <em>Econometrica</em> 73 (1):
245–61.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christophe Bruneel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
